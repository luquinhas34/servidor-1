generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/**
 * -------------------- Usuários --------------------
 */
model User {
  id       Int    @id @default(autoincrement())
  email    String @unique
  name     String
  password String
  role     String

  avaliacao         Avaliacao[]
  diarios           Diario[]
  tarefas           Atividade[]
  avisos            Aviso[]
  chamadas          Chamadas[]
  turmas            TurmaUsuario[]
  mensagens         Mensagem[]         @relation("MensagensAutor")
  chatsParticipando ChatParticipante[]
  responsavelDe     ResponsavelAluno[] @relation("ResponsavelRelacao")
  responsaveis      ResponsavelAluno[] @relation("AlunoRelacao")
  aluno             Aluno?
  professor         Professor?
  presencas         Presenca[]         @relation("PresencaAluno")
}

model Professor {
  id             Int      @id @default(autoincrement())
  name           String
  cpf            String
  telefone       String
  dataNascimento DateTime
  email          String
  matricula      String
  password       String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userId         Int      @unique
  user           User     @relation(fields: [userId], references: [id])
}

model Aluno {
  id             Int      @id @default(autoincrement())
  nome           String
  cpf            String
  telefone       String
  dataNascimento DateTime
  email          String
  cpfMae         String
  cpfPai         String
  senha          String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userId         Int      @unique
  user           User     @relation(fields: [userId], references: [id])
}

/**
 * -------------------- Turmas --------------------
 */
model TurmaUsuario {
  id       Int @id @default(autoincrement())
  userId   Int
  turmaIdt Int

  turma Turma @relation(fields: [turmaIdt], references: [idt])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([userId, turmaIdt])
}

model Turma {
  idt       Int     @id @default(autoincrement())
  nome      String
  descricao String?

  usuarios   TurmaUsuario[]
  chamadas   Chamadas[]
  presencas  Presenca[]
  Diario     Diario[]
  atividades Atividade[]
  avaliacoes Avaliacao[]
  horarios   Horario[]
  calendario Calendario?    @relation("Turma_Calendario")
  materias   TurmaMateria[] @relation("Turma_TurmaMateria")
}

/**
 * -------------------- Materias --------------------
 */
model Materia {
  id       Int       @id @default(autoincrement())
  nome     String    @unique
  horarios Horario[]
}

/**
 * Tabela de junção Turma x Materia
 */
model TurmaMateria {
  id        Int @id @default(autoincrement())
  turmaId   Int
  materiaId Int

  turma   Turma   @relation("Turma_TurmaMateria", fields: [turmaId], references: [idt])
  
  @@unique([turmaId, materiaId])
}

/**
 * -------------------- Horários --------------------
 */
model Horario {
  id        Int       @id @default(autoincrement())
  dia       String
  turno     String
  horaInicio String
  horaFim    String
  turmaIdt   Int
  turma      Turma    @relation(fields: [turmaIdt], references: [idt])

  materiaId  Int?
  materia    Materia? @relation(fields: [materiaId], references: [id])
}

/**
 * -------------------- Chamadas / Presença / Diário --------------------
 */
model Chamadas {
  id       Int      @id @default(autoincrement())
  data     DateTime @default(now())
  nome     String
  materia  String
  turmaIdt Int
  userId   Int

  turma     Turma      @relation(fields: [turmaIdt], references: [idt])
  user      User       @relation(fields: [userId], references: [id])
  presencas Presenca[]

  @@map("chamadas")
}

model Presenca {
  id        Int    @id @default(autoincrement())
  alunoId   Int
  chamadaId Int
  turmaIdt  Int
  status    Status

  turma   Turma    @relation(fields: [turmaIdt], references: [idt])
  chamada Chamadas @relation(fields: [chamadaId], references: [id])
  Diario  Diario[]
  aluno   User     @relation("PresencaAluno", fields: [alunoId], references: [id])

  @@map("presencas")
}

model Diario {
  id       Int      @id @default(autoincrement())
  alunoId  Int
  turmaIdt Int
  data     DateTime @default(now())
  status   Status
  userId   Int

  user      User       @relation(fields: [userId], references: [id])
  turma     Turma      @relation(fields: [turmaIdt], references: [idt])
  presencas Presenca[]

  @@map("diarios")
}

enum Status {
  PRESENCA
  FALTA
}

/**
 * -------------------- Atividades / Avaliações / Avisos --------------------
 */
model Atividade {
  id         Int      @id @default(autoincrement())
  titulo     String
  descricao  String
  turmaIdt   Int
  dataInicio DateTime
  dataFim    DateTime
  documento  String?
  userId     Int
  data       DateTime @default(now())

  turma Turma @relation(fields: [turmaIdt], references: [idt])
  user  User  @relation(fields: [userId], references: [id])
}

model Avaliacao {
  id         Int      @id @default(autoincrement())
  titulo     String
  descricao  String
  turmaIdt   Int
  dataInicio DateTime
  dataFim    DateTime
  documento  String?
  userId     Int
  data       DateTime @default(now())

  turma Turma @relation(fields: [turmaIdt], references: [idt])
  user  User  @relation(fields: [userId], references: [id])

  @@map("avaliacoes")
}

model Aviso {
  id        Int      @id @default(autoincrement())
  titulo    String   @db.VarChar(100)
  descricao String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    Int

  user User @relation(fields: [userId], references: [id])

  @@map("avisos")
}

/**
 * -------------------- Chat --------------------
 */
model Chat {
  id            Int                @id @default(autoincrement())
  titulo        String?
  participantes ChatParticipante[]
  mensagens     Mensagem[]
  updatedAt     DateTime           @updatedAt
}

model ChatParticipante {
  id     Int @id @default(autoincrement())
  userId Int
  chatId Int

  user User @relation(fields: [userId], references: [id])
  chat Chat @relation(fields: [chatId], references: [id])
}

model Mensagem {
  id          Int      @id @default(autoincrement())
  texto       String
  chatId      Int
  remetenteId Int
  data        DateTime @default(now())
  createdAt   DateTime @default(now())

  remetente User @relation("MensagensAutor", fields: [remetenteId], references: [id])
  chat      Chat @relation(fields: [chatId], references: [id])
}

/**
 * -------------------- Responsáveis --------------------
 */
model ResponsavelAluno {
  id            Int @id @default(autoincrement())
  responsavelId Int
  alunoId       Int

  responsavel User @relation("ResponsavelRelacao", fields: [responsavelId], references: [id])
  aluno       User @relation("AlunoRelacao", fields: [alunoId], references: [id])

  @@unique([responsavelId, alunoId])
}

/**
 * -------------------- Calendário --------------------
 */
model Calendario {
  id       Int                @id @default(autoincrement())
  nome     String
  ano      Int
  semestre Int
  eventos  EventoCalendario[]

  turmaId Int   @unique
  turma   Turma @relation("Turma_Calendario", fields: [turmaId], references: [idt])
}

model EventoCalendario {
  id           Int        @id @default(autoincrement())
  data         DateTime
  tipo         EventoTipo
  calendarioId Int
  calendario   Calendario @relation(fields: [calendarioId], references: [id])
}

enum EventoTipo {
  INICIO_BIMESTRE
  RECESSO
  SABADO_LETIVO
  FERIADO
}
